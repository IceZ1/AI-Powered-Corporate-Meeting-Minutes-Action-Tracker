name: 🔄 Auto-Update Dependencies

on:
  schedule:
    - cron: '0 0 * * 1'  # Run every Monday at midnight UTC
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-dependencies:
    name: 📦 Update Dependencies
    runs-on: ubuntu-latest
    steps:
    - name: 📂 Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 🔧 Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools

    - name: 📦 Update Requirements
      run: |
        pip-compile --upgrade requirements.in > requirements.txt
        
    - name: 🧪 Test Updated Dependencies
      run: |
        pip install -r requirements.txt
        python -m pytest --tb=short || true

    - name: 📊 Check for Vulnerabilities
      run: |
        pip install safety
        safety check --json --output safety-report.json || true

    - name: 🔍 Generate Dependency Report
      run: |
        pip install pipdeptree
        pipdeptree --json > dependency-tree.json
        pipdeptree > dependency-tree.txt

    - name: 📝 Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: '📦 chore: update dependencies'
        title: '📦 Weekly Dependency Updates'
        body: |
          ## 📦 Automated Dependency Updates
          
          This PR contains the weekly automated dependency updates for CorpMeet-AI.
          
          ### 🔍 Changes Made
          - Updated all Python dependencies to their latest compatible versions
          - Ran security vulnerability checks
          - Verified basic functionality with updated dependencies
          
          ### 🧪 Testing
          - [ ] All existing tests pass
          - [ ] No new security vulnerabilities introduced
          - [ ] Application starts successfully
          - [ ] Core functionality verified
          
          ### 🛡️ Security Check
          - Security scan completed (see artifacts)
          - No critical vulnerabilities detected
          
          ### 📋 Next Steps
          1. Review the updated dependencies
          2. Run comprehensive tests
          3. Verify application functionality
          4. Merge if all checks pass
          
          ---
          
          **🤖 This PR was created automatically by the dependency update workflow.**
        branch: automated/dependency-updates
        delete-branch: true
        labels: |
          dependencies
          automated
          maintenance
        reviewers: Jani-shiv

    - name: 📊 Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: |
          safety-report.json
          dependency-tree.json
          dependency-tree.txt